# Telegram Quiz Bot

Элементарный простейший чат-бот для проведения квизов в Telegram.

## Структура проекта

```
Project12/
├── app/                          # Основной пакет приложения
│   ├── __init__.py              # Инициализация пакета
│   ├── main.py                  # Точка входа приложения
│   ├── bot.py                   # Инициализация бота и диспетчера
│   ├── config.py                # Конфигурация (переменные окружения)
│   ├── logic.py                 # Логика квиза и данные вопросов
│   ├── db/                      # Модуль работы с базой данных
│   │   ├── __init__.py
│   │   ├── core.py              # Инициализация БД и создание таблиц
│   │   └── quiz.py              # Функции для работы с состоянием квиза
│   └── handlers/                # Обработчики сообщений и команд
│       ├── __init__.py
│       ├── start.py             # Обработчик команды /start
│       └── quiz.py              # Обработчики квиза и ответов
├── local.env                     # Файл с переменными окружения
├── pyproject.toml               # Конфигурация проекта
├── old_project.py               # Исходный монолитный файл (для справки)
└── README.md                    # Этот файл
```

## Описание модулей

### `app/main.py`
Точка входа приложения. Инициализирует базу данных, создает бота и диспетчер, регистрирует обработчики и запускает поллинг.

### `app/bot.py`
Модуль для создания экземпляров бота и диспетчера aiogram.

### `app/config.py`
Модуль конфигурации. Читает переменные окружения:
- `API_TOKEN` - токен Telegram бота
- `DATABASE_URL` - URL базы данных (по умолчанию SQLite)
- `LOG_LEVEL` - уровень логирования

### `app/logic.py`
Содержит:
- `quiz_data` - список вопросов квиза с вариантами ответов
- `new_quiz()` - функция для запуска/продолжения квиза и отправки инлайн-вопросов

### `app/db/core.py`
Инициализация базы данных:
- Создание директории для БД (если не существует)
- Создание таблицы `quiz_state` для хранения состояния квиза пользователей и статистики последней сессии

### `app/db/quiz.py`
Функции для работы с состоянием квиза:
- `start_quiz_session()` - запуск/перезапуск сессии квиза
- `set_question_index()` - сохранение текущего вопроса
- `record_answer()` - накопление статистики правильных/неправильных ответов
- `finish_quiz_session()` - завершение сессии и получение статистики
- `get_quiz_state()` - чтение текущего состояния пользователя

### `app/handlers/start.py`
Обработчик команды `/start`:
- Приветственное сообщение
- Кнопка меняется между «Начать игру» и «Прервать и показать результаты» в зависимости от активной сессии

### `app/handlers/quiz.py`
Обработчики квиза:
- Команда `/quiz` и кнопка «Начать игру» запускают сессию
- Кнопка «Прервать и показать результаты» завершает текущий квиз
- Callback-обработчик ответов на вопросы квиза
- После ответа кнопки предыдущего вопроса удаляются и показывается выбранный вариант
- Сохраняется статистика последней сессии и отправляется итоговое сообщение

## Установка и запуск

1. Установите зависимости:
```bash
pip install aiogram aiosqlite python-dotenv
```

2. Настройте переменные окружения в файле `local.env`:
```
API_TOKEN=ваш_токен_бота
DATABASE_URL=sqlite:///./db/quiz_bot.db
LOG_LEVEL=INFO
```

3. Запустите бота:
```bash
python -m app.main
```

Или из корня проекта:
```bash
cd Project12
python -m app.main
```

## Функционал

- Команда `/start` - приветствие и кнопка для начала игры
- Команда `/quiz` или кнопка «Начать игру» — запуск новой сессии
- Кнопка «Прервать и показать результаты» — досрочное завершение сессии и вывод статистики
- Интерактивные вопросы с вариантами ответов (инлайн-кнопки)
- После ответа кнопки удаляются, а сообщение дополняется выбранным вариантом
- Проверка правильности ответов и вывод правильного ответа при ошибке
- Сохранение состояния и статистики последней сессии пользователя в SQLite
- Автоматический переход к следующему вопросу и итоговое сообщение по завершении
- Финальное сообщение содержит блок:
  ```
  --------------
  "КВИЗ про python"
  Пользователь [USERNAME]:
  Правильных ответов: X
  Неправильных ответов: Y
  -------------------
  ```

## База данных

Используется SQLite для хранения состояния квиза каждого пользователя. База данных создается автоматически при первом запуске в директории `db/`.

Таблица `quiz_state`:
- `user_id` (INTEGER PRIMARY KEY) - ID пользователя Telegram
- `username` (TEXT) - никнейм/имя пользователя
- `question_index` (INTEGER) - индекс текущего вопроса
- `correct_answers` (INTEGER) - количество правильных ответов в последней сессии
- `incorrect_answers` (INTEGER) - количество неправильных ответов в последней сессии
- `is_active` (INTEGER) - признак активной сессии


